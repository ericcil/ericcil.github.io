---
title: 数据口径问题
date: 2018-05-29 20:05:34
tags:
category: 工作实践
---

###


<!-- more -->

今天接到一个财务统计的问题：月底财务要对项目的购销情况和资金情况进行清算。项目里有个sap的功能，是每天将财务数据和购销数据进行统计汇总上报集团sap，之后再由财务对账处理。正常情况下来说 ***一笔资金的出入必定会对应有商品的采购和销售***，但是清算后发现有部分财务数据没有对应的购销数据。
首先对业务代码进行检查，发现原来的业务代码耦合度高，重复代码多，代码逻辑也过分复杂，大部分的数据初始化工作都在dao层，使用连接查询完成。

```java
//当前时间
Date date = new Date();
//客户全额还款流水
vapAmountWaterService.queryCustFullSerialData(date);
//首付和全额购买和退款商品流水
vapAmountWaterService.queryDownAndFullProductSerialData(date);
//财务调整收款凭证
vapAmountWaterService.queryFinancialCertificateData(date);
//采购订单
vapAmountWaterService.queryPurchaseOrderData(date);
//采购订单退款流水
vapAmountWaterService.queryPurchaseOrderRefundSerialData(date);
//销售订单
vapAmountWaterService.querySalesOrderData(date);
//VBS业务对应数据
vapAmountWaterService.queryVBSBusinessData(date);

```

由于上述的几个原因，还有现在的问题并不是必然发生，我马上就搁置了代码逻辑的梳理，然后转向分析sql逻辑，对比过几个提数的sql后马上就发现了问题：每句sql都是以上层传入的date作为参数，但是sql之间作为条件判断的依据字段是不同的，这就造成了sql的口径不一致！

```xml

<select id="findByOrderCreateTime" resultMap="financialCertificate">
    SELECT 
        ......
    FROM  o
    LEFT JOIN  ok ON ok.order_id = o.ID
    LEFT JOIN  od ON od.order_id = o.id
    where DATE_FORMAT(ok.down_payment_time,'%Y-%m-%d') = DATE_FORMAT(#{date},'%Y-%m-%d') 
    and ok.jd_trade_no != ''
    AND od.order_level = 1
</select>

<select id="queryPurchaseOrderData" resultMap="purchaseOrder">
    SELECT
        ......
    FROM  o
    LEFT JOIN  oa ON o.id = oa.order_id 
    LEFT JOIN  ok ON ok.order_id = o.ID
    LEFT JOIN  op ON op.order_id = o.ID
    LEFT JOIN  ps ON ps.id = op.product_supplier_id 
    LEFT JOIN  sup ON sup.id = ps.supplier_id 
    LEFT JOIN  ct ON ct.order_id = o.ID
    where o.order_type = 2 
    and oa.audit_status = 2 
    and ct.contract_type = '1' 
    and DATE_FORMAT(oa.create_time,'%Y-%m-%d') = DATE_FORMAT(#{date},'%Y-%m-%d')
</select>
```

***（隐去了结果集的具体字段和表的实际名称）***

正是由于时间口径的不一致，造成了当资金业务和购销业务时间记录差大于一天的情况下必然出现统计出的数据不对称的情况（造成中间时间差的原因也是业务流程）。这样问题找到之后针对时间口径进行统一，应急处理就算完成了。

总结：
1. 开发人员对于数据是需要较高的敏感度的，在做提数类需求的时候，数据口径一定要确认。
2. 针对发生问题的这个业务，有几个改进方案
    - 改动逻辑，在拉取到资金流水之后，根据资金流水查找购销记录，同时做系统内校验（或者以购销记录为基准）
    - 不改动逻辑，在查询完毕之后增加资金流水与购销的比对校验，提前侦测异常数据 