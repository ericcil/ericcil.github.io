---
title: jenkins部署小结
date: 2018-05-19 22:42:10
tags:
category:
---

###


<!-- more -->

&emsp;&emsp;
前段时间在使用测试环境jenkins时，经常发生点击构建，jenkins无任何动作的情况，进入服务器查看后发现是可用硬盘空间为0了。

深入了解后发现该台测试服务，和其他测试服务器的分区不同，绝大部分的硬盘空间都属于volgroup-lv_home，而用于安装应用的root下只有50G。由于应用较多，长时间日志写入，造成空间经常被撑满。虽然可以通过清理日志文件暂时解决jenkins无法执行构建的问题。但是考虑到之后对测试服务器的统一管理，还是决定要重新分配该服务器硬盘空间。
为了不影响测试环境的正常使用，需要将该服务器上部署的jenkins，maven，nexus，solr进行转移。
首先，我挑选了一台服务器，去官网下载了最新的稳定版jenkins.war。然而在启动jenkins时发现这台服务器上安装了三个版本的jdk，而且都达不到当前使用的jenkins要求的最低版本。然后我就选择卸载了已安装的jdk，安装了项目环境依赖的java8。

使用 java -jar jenkins.war --httpPort=8089

安装maven，启动jenkins，安装plugins，配置jenkins，配置工程之后
点击构建。打包都是正常的，然而在执行启动项目tomcat脚本的时候，无法正常启动。jenkins控台没有异常日志输出，查看tomcat catalina.out日志，发现报了一个诡异的错误：
***异常日志内容意思为环境变量声明的jdk不存在***
经过排查，发现原本jenkins执行的脚本首行有这样的内容：

```shell
#/bin/bash
export JAVA_HOME=/usr/local/java/java7
```

然而我在之前配置环境时就已经把原有的java7卸载，并配置了java8，问题到这里就很明显了：在jenkins构建结束之后，执行了该脚本，把环境变量里的JAVA_HOME重新设置了，在tomcat启动时，无法根据环境变量找到安装的jdk，便无法正常启动。
这里我选择了注释掉export命令。并且重新设置JAVA_HOME
再次使用jenkins构建时又输出了以下异常：
<img src="../img/jenkins_msg.png">
看到这个异常之后，我感觉很不解，明明已经配置好了环境变量，为什么jenkins执行shell脚本的时候还会报没有环境变量的配置。然后我选择了把修改脚本里export的java路径，重新尝试构建，便可以成功执行完成。

目前也还不知道为什么脚本里不添加export就不能正常执行的原因