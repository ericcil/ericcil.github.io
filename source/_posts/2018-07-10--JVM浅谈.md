---
title: JAVA类加载
date: 2018-07-10 09:22:34
tags: 类加载
category: JVM
---

###


<!-- more -->
##类加载
类的加载指 .class文件中的二进制数据读到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个java.lang.Class对象，用来封装类在方法区内的数据结构。
>.class文件 --> 方法区 --> 堆
JVM规范允许类加载器在预料到某个类将被使用，预先加载该类，如果预先加载过程遇到错误，类加载器必须在程序首次主动使用该类时报告错误（LinkageError）

类加载方式：
- 从本地系统加载
- 通过网络下载.class
- 从zip，jar等归档文件中加载
- 从专有数据库中提取.class
- 将java源文件动态编译为.class


###类生命周期
>类的加载过程
加载（loading） --> 验证(verification) --> 准备(preparation) --> 解析(resolution) --> 初始化(initialization)
生命周期还包含
--> 使用(using) --> 卸载(unloading)

加载过程中加载、验证、准备和初始化这四个阶段发生顺序是确定的，解析则不一定，某系情况下可以在初始化阶段之后开始（为了支持动态绑定）。

<font size=5px color='gree'>加载阶段</font>
**1. 加载**
    - 通过类的全限定名获取二进制字节流
    - 将字节流代表的静态存储结构转为方法区的运行时数据结构
    - 在堆中生成一个改类的java.lang.Class对象，作为方法区中数据的访问入口

<font size=5px color='gree'>连接阶段</font>
**1. 验证**
    - 文件格式验证
    - 元数据验证
    - 字节码验证
    - 符号引用验证
    
目的是为了确保class文件的字节流中包含的信息是否符合当前虚拟机的要求，且不会危害虚拟机自身的安全。
>验证步骤是重要但是非必要的，<font size=4 color=#D2691E>可以通过- Xverifynone 参数来关闭大部分验证，缩短虚拟机类加载时间。</font>

**2. 准备**

准备阶段是为了类变量分配内存并设置类变量初始值的阶段，这些内存都放在方法区中分配。
- 该阶段分配的只包括静态变量（static）,不包括实例变量，实例变量会在对象实例化时随对象分配在堆中
- 该阶段设置的初始值通常是数据类型默认的零值（如0,0L,null,false等）实际代码中的赋值会在初始化阶段执行。
- 如果类字段（static）被final修饰，那么在该阶段会直接初始化为代码中指定的值

**3. 解析**

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程

**4. 初始化**

初始化阶段为类的静态变量赋予正确的初始值

类初始化的时机：当出现对类的主动使用才进行初始化
>主动引用包括：
>- 创建类实例，即new方式
>- 访问某个类或接口的静态变量，或者对静态变量赋值
>- 调用类的静态方法
>- 反射（Class.forName("com.er.Test")
>- 子类被初始化
>- JVM启动时被标为启动类的

JVM初始化步骤：
1、若还未加载、连接该类，则进行加载、连接
2、若该类的父类还未初始化，初始化直接父类
3、若该类存在初始化语句，则依次执行初始化语句

<font size=5px color='gree'>生命周期结束</font>
以下几种情况，JVM将结束生命周期
- 执行了System.exit()方法
- 程序正常执行结束
- 程序在执行过程中遇到了异常或错误导致终止
- 由于操作系统导致JVM进程终止


###类加载器

- 启动类加载器 Bootstrap ClassLoader
    负责加载存放在 <font size=4 color=#E9C1A4>jdk安装路径\jre\lib</font> 下，或者被 <font size=4 color=#E9C1A4>-Xbootclasspath</font>参数所指定路径的，且能被虚拟机识别的类库（如rt.jar，java.开头的类均被Bootstrap ClassLoader加载）
- 扩展类加载器
    负载加载 <font size=4 color=#E9C1A4>jdk安装路径\jre\lib\ext</font> 下，或者由<font size=4 color=#E9C1A4>系统变量 java.ext.dirs</font>指定路径下的所有类库（如 javax.开头的）
- 应用程序类加载器
    负载加载用户路径（classPath）指定的类


<font size=5px color='gree'>类加载机制</font>
1. 全盘负责：当一个类加载器负责加载某个class时，该class依赖的和引用的其他class也由该类加载器负责载入，除非显示使用另外一个类加载器
2. 父类委托（双亲委派）：先让父类加载器加载，只有父类加载器无法加载时才尝试从自己的类路径加载
3. 缓存机制：缓存所有加载过的class，当程序中需要使用某个class时，先从缓存区找该class，只有缓存区中找不到该类的时候，才会加载class对象

###类加载方式
- 命令行启动时由JVM初始化加载
- 通过Class.forName()动态加载
- 通过ClassLoader.loadClass()动态加载

>ClassLoader.loadClass()加载类时只做加载动作，准备动作要在newInstance时才做
Class.forName()加载时除了加载，还会执行准备动作，执行类中的static块
Class.forName(name,initialize,loader)带参数的函数可以控制是否加载static块

双亲委派的意义：
- 防止内存中出现多份同样的字节码
- 保证java程序安全稳定运行

