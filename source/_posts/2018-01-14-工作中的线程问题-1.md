---
title: 工作中的线程问题-1
date: 2018-01-14 09:08:07
tags:
category:
---

###


<!-- more -->

&emsp;&emsp;上周，项目的后台系统出现了一个问题，一个供应商在更新成本价的时候，发现报价发生了变更，但是展现的商品价却没有变更。一开始知道这个问题的时候首先想到的是缓存没有刷新，不过在听到负责开发的同事描述了代码逻辑，基本就确定了是线程问题。
&emsp;&emsp;我粗略描述下其中的实现逻辑：
* 表 ta：记录商品价格，由不同货源的报价综合评定
* 表 tb：记录不同货源的报价
* 报价 op
* 代码实现：
供应商输入报价->
{
&emsp;&emsp;1.update tb;
&emsp;&emsp;2.op = query tb;
&emsp;&emsp;3.update ta with op;
&emsp;&emsp;4.update cache;
}
其中3,4操作的时候开启了第二个线程
&emsp;&emsp;虽然3,4操作开启了第二个线程，不过由于有数据依赖关系，重排之后3,4的执行还是会在2之后，所以问题点不在这里。但是2,1，虽然逻辑上存在依赖关系，但是代码中没有数据依赖关系，在这里就可能被重排。
### 简单的处理方式
&emsp;&emsp;1操作时会返回数据库被更新的条数，在1,2之间引入一个count的判断，如：
count = update tb;
if(count > 0)
    op = query tb;
这样让1,2直接产生数据依赖，避免重排的影响。
&emsp;&emsp;根本上来说，这种问题是可以避免的。当系统输入最新报价的时候，我们就已经获取到这个值了，无需再采用更新之后再查询的方式。


